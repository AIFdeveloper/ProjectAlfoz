<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–Ω–ª–∞–π–Ω —Ç–µ—Å—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ --- */
body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #333;
}
.container {
    max-width: 900px;
    margin: 40px auto;
    background: #fff;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 15px 30px rgba(0,0,0,0.2);
}
h1 {
    text-align: center;
    margin-bottom: 30px;
    color: #333;
}
/* --- –¢–∞–π–º–µ—Ä --- */
#timer {
    font-size: 20px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 20px;
    color: #333;
}
.warning {
    color: #ff4d4d;
    animation: blink 1s infinite;
}
@keyframes blink {
    0%,50%,100% { opacity: 1; }
    25%,75% { opacity: 0; }
}
/* --- –í–æ–ø—Ä–æ—Å—ã --- */
.question {
    background: #f8f9fa;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    line-height: 1.6;
}
.question.correct { border-left: 6px solid #28a745; background: #e6ffed; }
.question.wrong { border-left: 6px solid #dc3545; background: #ffe6e6; }
.question b { display: block; margin-bottom: 15px; font-size: 18px; }
label { display: block; margin-bottom: 10px; cursor: pointer; font-size: 16px; }
input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); accent-color: #667eea; }
/* --- –ö–Ω–æ–ø–∫–∏ --- */
button {
    padding: 12px 25px;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin: 10px 5px 0 0;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
#startBtn { background: #667eea; color: #fff; }
#startBtn:hover { background: #5a67d8; }
#checkBtn { background: #28a745; color: #fff; }
#checkBtn:hover { background: #218838; }
#retryBtn { background: #f59e0b; color: #fff; }
#retryBtn:hover { background: #d97706; }
/* --- –†–µ–∑—É–ª—å—Ç–∞—Ç --- */
#result {
    margin-top: 25px;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    font-size: 18px;
}
/* --- –ü–æ–ª—è –≤–≤–æ–¥–∞ --- */
input[type=file], input[type=number] {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    margin-bottom: 15px;
}
</style>
</head>
<body>
<div class="container">
    <h1>üìò  ALFOZ –æ–Ω–ª–∞–π–Ω —Ç–µ—Å—Ç</h1>

    <p><b>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ—Å—Ç (.txt):</b></p>
    <input type="file" id="fileInput" accept=".txt">

    <p>‚è± –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (—Å–µ–∫—É–Ω–¥—ã): <input type="number" id="timerInput" value="60" min="10" max="3600"></p>

    <div id="startContainer">
        <button id="startBtn" disabled>–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
    </div>

    <div id="timer">‚è± –í—Ä–µ–º—è: 60</div>
    <div id="attempts">–ü–æ–ø—ã—Ç–∫–∏: 0</div>

    <form id="testForm"></form>

    <button id="checkBtn" onclick="checkTest()" disabled>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
    <button id="retryBtn" onclick="retryTest()" disabled>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>

    <div id="result"></div>
</div>

<script>
let correctAnswers = [];
let timeLeft = 60;
let timerInterval;
let testFinished = false;
let attempts = 0;
let loadedFile = null;

// --- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Å–∏–º–≤–æ–ª–æ–≤
function escapeHTML(text) {
    return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
document.getElementById("fileInput").addEventListener("change", e => {
    loadedFile = e.target.files[0];
    if(!loadedFile) return;
    document.getElementById("startBtn").disabled = false;
    document.getElementById("testForm").innerHTML = "";
    document.getElementById("result").innerHTML = "";
    document.getElementById("timer").innerText = `‚è± –í—Ä–µ–º—è: 60`;
});

// --- –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
document.getElementById("startBtn").addEventListener("click", () => {
    if(!loadedFile) return;
    const inputTime = parseInt(document.getElementById("timerInput").value);
    timeLeft = (!isNaN(inputTime) && inputTime > 0) ? inputTime : 60;
    startNewTest(loadedFile);
    document.getElementById("startBtn").disabled = true;
    document.getElementById("checkBtn").disabled = false;
    document.getElementById("retryBtn").disabled = false;
});

// --- –ù–æ–≤—ã–π —Ç–µ—Å—Ç
function startNewTest(file) {
    testFinished = false;
    clearInterval(timerInterval);
    document.getElementById("timer").classList.remove('warning');
    document.getElementById("result").innerHTML = "";
    document.getElementById("checkBtn").disabled = false;

    const reader = new FileReader();
    reader.onload = () => {
        showTest(reader.result);
        startTimer();
    };
    reader.readAsText(file);
}

// --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
function showTest(text) {
    text = text.replace(/\r\n/g,"\n").trim();
    let blocks = shuffleArray(text.split(/\n\s*\n/));
    const form = document.getElementById("testForm");
    form.innerHTML = "";
    correctAnswers = [];

    blocks.forEach((block,index) => {
        const lines = block.split("\n").map(l => l.trim());
        if(!lines[0]) return;
        let answerIndex = lines.findIndex(l => l.startsWith("ANSWER:"));
        if(answerIndex === -1) return;

        let questionLines = lines.slice(0, answerIndex);
        let answerLine = lines[answerIndex];

        let questionText = "";
        let options = [];
        questionLines.forEach(line => {
            if(/^[ABCDEF]:/.test(line)) options.push(line);
            else questionText += line + " ";
        });
        questionText = questionText.trim();

        const answers = answerLine.split(":")[1].split(",").map(a => a.trim());
        correctAnswers.push(answers);

        options = shuffleArray(options);

        let html = `<div class='question' id='q${index}'><b>${escapeHTML(index+1 + ". " + questionText)}</b>`;
        options.forEach(line => {
            const letter = line[0];
            const text = line.slice(2).trim();
            html += `<label><input type='checkbox' name='q${index}' value='${letter}'> ${letter}: ${escapeHTML(text)}</label>`;
        });
        html += `</div>`;
        form.innerHTML += html;
    });
}

// --- –¢–∞–π–º–µ—Ä
function startTimer() {
    clearInterval(timerInterval);
    const timerElem = document.getElementById("timer");
    timerElem.innerText = `‚è± –í—Ä–µ–º—è: ${timeLeft}`;
    timerElem.classList.remove('warning');

    timerInterval = setInterval(() => {
        if(testFinished){ clearInterval(timerInterval); return; }
        timeLeft--;
        timerElem.innerText = `‚è± –í—Ä–µ–º—è: ${timeLeft}`;
        if(timeLeft <= 10) timerElem.classList.add('warning');
        if(timeLeft <= 0){ clearInterval(timerInterval); if(!testFinished) checkTest(true); }
    },1000);
}

// --- –ü—Ä–æ–≤–µ—Ä–∫–∞
function checkTest(auto=false){
    if(testFinished) return;
    testFinished = true;
    clearInterval(timerInterval);

    let right=0, wrong=0;
    correctAnswers.forEach((correct,i)=>{
        const selected = [...document.querySelectorAll(`input[name='q${i}']:checked`)].map(el=>el.value);
        const block = document.getElementById(`q${i}`);
        if(arraysEqual(selected.sort(), correct.sort())){ right++; block.classList.add("correct"); }
        else { wrong++; block.classList.add("wrong"); }
    });

    const total = correctAnswers.length;
    const percent = Math.round((right/total)*100);
    let grade='';
    if(percent>=90) grade='–û—Ç–ª–∏—á–Ω–æ';
    else if(percent>=70) grade='–•–æ—Ä–æ—à–æ';
    else if(percent>=50) grade='–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ';
    else grade='–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑';

    let resultText = `${auto ? '‚è≥ –í—Ä–µ–º—è –≤—ã—à–ª–æ!<br>' : ''}‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: ${right}<br>‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: ${wrong}<br>üìä –ü—Ä–æ—Ü–µ–Ω—Ç: ${percent}%<br>üéì –û—Ü–µ–Ω–∫–∞: ${grade}`;
    document.getElementById("result").innerHTML = resultText;
    document.querySelectorAll("input").forEach(i => i.disabled=true);
    document.getElementById("checkBtn").disabled = true;
    attempts++;
    document.getElementById("attempts").innerText = `–ü–æ–ø—ã—Ç–∫–∏: ${attempts}`;
}

// --- –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
function retryTest(){
    if(!loadedFile) return;
    testFinished=false;
    clearInterval(timerInterval);
    document.getElementById("testForm").innerHTML = "";
    document.getElementById("result").innerHTML = "";
    document.getElementById("timer").innerText=`‚è± –í—Ä–µ–º—è: ${document.getElementById("timerInput").value || 60}`;
    document.getElementById("timer").classList.remove('warning');
    document.getElementById("startBtn").disabled=false;
    document.getElementById("checkBtn").disabled=true;
    document.getElementById("retryBtn").disabled=true;
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function arraysEqual(a,b){ return a.length===b.length && a.every((v,i)=>v===b[i]); }
function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}return array;}
</script>
</body>
</html>
